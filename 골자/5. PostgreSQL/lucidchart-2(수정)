(피피티)
이제 본격적으로 관계형데이터베이스의
관계에 대해 알아볼거에요
핵심은 두 관계 사이의 맥시멈을 아는겁니다.
딱 이 두가지 형태만 기억할게요
매니인지
원인지

(다음)
두 개의 테이블 사이엔 두 개의 질문이 필요합니다.
유저와 텍스트간의 관계를 파악해보죠
유저와 텍스트 사이의 관계를 생각해보겠습니다.
하나의 유저가 가질 수 있는 최대 텍스트는 몇개일까?
여러개겠죠. 매니.
그리고 하나의 텍스트가 가질 수 있는 최대 유저는 몇 개일까?
하나겠죠. 원.
그려보면 다음과 같습니다.

(다음)
유저는 여러개 텍스트를 가지고
텍스트는 하나의 유저를 가지죠

(실습)
그려보면 다음과 같이 그릴 수 있어요

...

이제 다른 관계도 파악해봅시다.
하나의 유저는 최대 몇개의 코멘트를 가져요?
매니
하나의 코멘트는 최대 몇 개의 유저를 가져요?
원
다음과 같이 그릴 수 있고

하나의 코멘트는 최대 몇 개의 텍스트를 가져요?
원
하나의 텍스트는 최대 몇 개의 코멘트를 가져요?
매니

이렇게 그릴 수 있겠죠

이거 왜 그렸을까?
관계는 단순히 줄만 긋는다고 설정되는게 아니에요
관계의 핵심은 외래키, 영어로는 포린키, 줄여서 에프케이입니다.
다른 테이블에 있는 피케이
그걸 어디에 두는건, 다음에 따라서 결정됩니다.

(다음)
첫번째, 원투매니
이 경우에 포린키는 매니쪽에 둡니다.
왜 원 쪽에 두면 안되는데?
원 쪽에 둬볼게요

(다음)
조교행님이 글을 쓰면 쓸수록 유저테이블은 중복이 계속 발생할겁니다.
유저테이블은 딱 유저 리스트만 관리했으면 좋겠죠?
그리고 더 심각한 문제는 피케이가 똑같은게 두개가 생긴다는거에요
아이디는 씨리얼이 아니라 텍스트라서 중복이 생길수밖에 없고
씨리얼로 한다고 하더라도 계속해서 중복이 발생할거에요 

(다음)
만약 매니쪽에 둔다면 훨씬 깔끔하게 처리할 수 있죠.
유저는 딱 유저만 관리하고
텍스트는 딱 텍스트만 관리하는데
각 텍스트는 누가 썻는지를 나타내는
유저 아이디라는 에프케이가 있을테니까요

(다음)
그럼 원 투 원 관계에선 어떻게 해야할까
이 경우는 어느 테이블이 좀 더 자유롭게 추가할 수 있는가를 따져야되요
지금 이알디에선 파악 불가능해요 원투원 관계가 없어요
그래서 억지로 하나 만들게요

(실습)
이즈 액티베이트 이걸 삭제하고 테이블을 하나 만들어서 관리한다 칩시다.
휴면여부를 담당하는 테이블을 따로 만드는거에요
테이블네임은 inactivity 로 하겠습니다.
피케이를 달아둡시다
인액티비티 아이디
해서 시퀀스니깐 자동증가하도록 씨리얼로 두고
하나의 인액티비티는 최대 몇 명의 유저를 가질까?
하나죠. 묶어서 관리하진 않으니깐
그럼 한명의 유저는 최대 몇 개의 인액티비티를 가집니까?
역시 하나죠. 
그래서 원투원 관계인데
이 경우에, 어느쪽이 데이터를 자유롭게 추가할 수 있어요?
당연히 유저입니다.
왜? 유저가없으면
인액티비티는 아무 쓸모가 없거든요
즉, 인액티비티는 유저에 종속되어있는거에요
그러면 어디에 에프케이를 둬야겠어요

(피피티)
만약에 유저에 뒀다고 칩시다
그러면 다음과 같이 널값이 생기겠죠
왜? 휴면하고 상관없는 유저들까지도
해당 애트리뷰트를 가져야만 되니깐.
그러니깐 이 경우 종속판단을 잘못한 경우입니다.

(다음)
이 경우는 널값이 발생하지 않죠
즉 원투원 관계에서는 어느 테이블이 데이터 추가 삭제가 더 자유로운가로 판단해야됩니다.
판단이 들어가기 때문에, 가장 어려워요

(다음)
마지막 남은건 매니투매니입니다.
이 경우엔 가만히 두면 안되요 
중간에 브릿지테이블을 하나 더 만들어야됩니다.
브릿지 무슨뜻입니까. 다리라는 뜻이죠
다른말로는 매핑테이블이라고도 합니다.
어떤 경우가 있을 수 있을까
우리 예제에선 매니투매니 관계가 없는데
다음 예제 한번 보죠

(다음)
주문배송시스템을 설계한다고 가정할게요
한명의 고객은 최대 몇 개의 상품을 주문할 수 있는가?
여러개
그리고 하나의 상품은 최대 몇 명의 고객한테 팔릴 수 있는가?
여러개
그래서 매니 투 매니 관계가 성립하죠
근데 이 경우엔 다음과 같은 문제가 발생합니다. 
고객이 언제 해당 상품을 주문했는가를 알수가 없어요
그리고 널값과 중복값이 발생할수밖에 없습니다.

(다음)
커스터머 테이블에 에프케이를 두면 언제 샀는지도 모르고 중복도 발생하죠
이것 역시 피케이가 중복되니깐 아예 이렇게 쓰면 안되는겁니다.
그리고 보시면 널값도 발생하죠

(다음)
이 경우는 어떻습니까
프로덕트 아이디를 씨리얼로 처리해 자동증가한다하더라도
효율적이지 못하죠. 상품 전체를 관리하는테이블인데
중복해서 계속 늘어나잖아요
언제 샀는지는 알 수 있어요? 그것도 알 수 없죠
그래서 이것 역시도 효율적이지 못합니다.

(다음)
즉, 매니 투 매니일 경우엔 브릿지 테이블을 둬야합니다.
중간에 이어주는 테이블을 하나 둬서
매니 투 매니 관계를 끊어낼 필요가 있습니다.

(다음)
이런식으로요
보통 브릿지테이블 넣을땐 시간을 추가로 넣어줍니다
여기선 오더드 타임으로 넣어줬고
두개의 에프케이를 받고있죠?
이렇게 하면 언제 주문받았는지도 알수있고
커스터머는 고객정보에 집중하니깐 중복도 안생길거고
프로덕트도 상품에만 집중할거고
널값도 안생길겁니다.
브릿지 테이블을 둬서 문제를 해결했어요
참고로, 피케이는 중복하면 안되는 고유한 아이디이지만
에프케이는 중복 얼마든지 가능합니다.
오더 넘버는 달라도
같은 고객이 얼마든지 다른날 같은 제품을 시킬 수 있기 때문입니다.

(실습)
우리 이알디를 완성해봅시다
모두 원투매니 관계네요
매니쪽에 에프케이둔다그랬죠

.....

그리고 피케이와 에프케이를 다음과 같이 이어줍니다.

완성됐어요
이걸 어떻게 할 수 있느냐
엑스포트해보죠
포스트그래스큐엘 구문으로
짜잔 다음과 같이 나와요
근데 이걸 그대로 같다붙이지 마시고
문법에 맞는지 확인하고 에디터로 수정한다음에 붙여넣어야겠죠?
특히 낫널은 적용이 안되요 써줘야됩니다.
주욱 긁어서
주욱 집어넣어봅시다
그리고 테이블플러스 켜보면
예쁘게 들어간것을 확인할 수 있어요
엄청나게 어려웠죠? 디비 수업 듣느라 수고 많으셨습니다.
다음 영상에서 수업 마무리하도록 하죠
